<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: background/searchTermSetup.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: background/searchTermSetup.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @module background script - searchTermSetup
 */
'use strict';

/**
 * Searches for possible search terms in the user's browser history. Saves the results
 * to the 'searchTerms' objectStore in our database.
 * 
 * @param {function} [callback] Optional callback function. 
 */
function loadSearchTerms(callback) {
	clearDatabase('searchTerms', () => {
		chrome.history.search({
			text: '',
			'startTime': startTime
		}, historyItems => {
			asyncArrLoop(historyItems, (item, inCallback) => {
				if (item.url.indexOf('?') &lt; 0) { // Only consider urls with parameter
					inCallback();
					return;
				}
			
				getSearchTerm(item.url, inCallback);
			}, callback, 0);
		});
	});
}

/**
 * Grabs the search term for a given url.
 * 
 * @param {string} url The visited website.
 * @param {function} [callback] Optional callback function.
 */
function getSearchTerm(url, callback) {
	// Only consider urls with parameters
	if (url.indexOf('?') &lt; 0) {
		typeof callback === 'function' &amp;&amp; callback();
		return;
	}

	var key = getKeyFromUrl(url);

	getFromDatabase('searchParams', key, result => {
		// Find out url params, since they are not existing in our database yet.
		if (result == undefined) {
			// Find out parameter and afterwards get search terms for the url.
			getSearchParam(url, () => {
				// Make sure we found a parameter to avoid endless loops
				getFromDatabase('searchParams', key, newResult => {
					if (newResult != undefined) {
						getSearchTerm(url, callback);
					} else {
						// Can not find parameter, so mark as not searchable
						storeInDatabase('searchParams', key, '', true, callback);
					}
				});
			});
		} else {
			var term = new URLSearchParams(url.split('?')[1]).get(result.value[0]);

			if (term != null &amp;&amp; term.trim().length > 0) {
				storeInDatabase('searchTerms', key, decodeURIComponent(term), true, callback);
				return; // Avoid double callback call
			}

			typeof callback === 'function' &amp;&amp; callback(); // Call callback, if it is defined
		}
	});
}

/**
 * Finds out the search parameter for a given url.
 * 
 * @param {string} url The url for which we want to determine the search parameter.
 * @param {function} [callback] Optional callback function, executed when done.
 */
function getSearchParam(url, callback) {
	chrome.tabs.create({
		windowId: windowId,
		index: currentTabs.length,
		url: url.split('?')[0],
		active: false
	}, tab => {
		tab.isNew = true;
		tab.type = 'getUrlParam';
		tab.callback = callback; // Call callback, when tab is done
		specialTabs[specialTabs.findIndex(elem => elem.id == -1)] = tab;
	});
}

/**
 * Sets the url parmaeter for a given url.
 * 
 * @param {string} url The url for which we want to set the parameter.
 * @param {string} originUrl The origin url (some pages redirect on search).
 * @param {string} dummyTerm The search term used to find out the parameter.
 * @param {function} [callback] Optional callback function.
 */
function saveSearchParam(url, originUrl, dummyTerm, callback) {
	if (dummyTerm == '') {
		storeInDatabase('searchParams', getKeyFromUrl(url), '', false, callback);
		return;
	}

	var params = new URLSearchParams(url.split('?')[1]);
	for (const [key, val] of params.entries()) {
		if (val.toLowerCase() == dummyTerm.toLowerCase()) { // Some sites capitalize queries
			// Some sites redirect on search, so we make sure that we add url as well as originUrl.
			storeInDatabase('searchParams', getKeyFromUrl(originUrl), key, false, () => {
				storeInDatabase('searchParams', getKeyFromUrl(url), key, false, () => {
					chrome.history.deleteUrl({
						url: url
					}, () => {
						chrome.history.deleteUrl({
							url: originUrl
						}, callback);
					});
				});
			});
			
			return;
		}
	}

	typeof callback === 'function' &amp;&amp; callback();
}</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-background%2520script%2520-%2520browserHistory.html">background script - browserHistory</a></li><li><a href="module-background%2520script%2520-%2520browserWindow.html">background script - browserWindow</a></li><li><a href="module-background%2520script%2520-%2520connection.html">background script - connection</a></li><li><a href="module-background%2520script%2520-%2520database.html">background script - database</a></li><li><a href="module-background%2520script%2520-%2520message.html">background script - message</a></li><li><a href="module-background%2520script%2520-%2520searchTermGeneration.html">background script - searchTermGeneration</a></li><li><a href="module-background%2520script%2520-%2520searchTermSetup.html">background script - searchTermSetup</a></li><li><a href="module-background%2520script%2520-%2520settings.html">background script - settings</a></li><li><a href="module-background%2520script%2520-%2520setup.html">background script - setup</a></li><li><a href="module-background%2520script%2520-%2520thirdParty.html">background script - thirdParty</a></li><li><a href="module-background%2520script%2520-%2520util.html">background script - util</a></li><li><a href="module-background%2520script%2520-%2520windowState.html">background script - windowState</a></li><li><a href="module-content%2520script%2520-%2520search.html">content script - search</a></li><li><a href="module-content%2520script%2520-%2520setup.html">content script - setup</a></li><li><a href="module-content%2520script%2520-%2520tab.html">content script - tab</a></li><li><a href="module-content%2520script%2520-%2520util.html">content script - util</a></li><li><a href="module-html%2520script%2520-%2520extensionPage.html">html script - extensionPage</a></li><li><a href="module-html%2520script%2520-%2520workingPage.html">html script - workingPage</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.5</a> on Wed Sep 16 2020 06:29:09 GMT+0000 (Greenwich Mean Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
